# üí≥ Paystack Wallet Service: Backend Stage 8 Submission

## üåü Project Overview

This is a robust backend service designed to handle core wallet operations: **deposits** via Paystack, **transfers** between users, and comprehensive **authentication** using both user-based **JSON Web Tokens (JWT)** and service-based **API Keys**.

### Key Features
* **Paystack Integration:** Deposits handled via Paystack, utilizing mandatory, secure webhook processing for successful crediting.
* **Dual Authentication:** Supports **JWT** (from Google Sign-in) for users and **API Keys** for service-to-service access.
* **API Key Management:** Includes endpoints for key creation, listing, rollover, and managing permissions/limits (max 5 active keys).
* **Atomic Transfers:** Wallet-to-wallet transfers are implemented to ensure atomicity and integrity.
* **Idempotency:** Webhook processing ensures no double-crediting occurs.

---

## ‚öôÔ∏è Configuration & Environment Variables

The service relies on the following environment variables. **Note the adjustments required for deployment on Render, particularly the callback and application URLs.**

### Required Variables

| Variable Name | Example Value (Local) | **Render/Deployment Value** | Notes |
| :--- | :--- | :--- | :--- |
| **`PORT`** | `3000` | `3000` | Port the app listens on. |
| **`APP_URL`** | `http://localhost:3000` | `https://<Your Render URL>` | **CRITICAL:** The public, secure URL of your deployed service. |
| **`DATABASE_URL`** | `postgres://user:pass@host:port/db...` | *(Your full Neon connection string)* | **CRITICAL:** Your complete, secure database URL. |
| **`JWT_SECRET`** | `fff02ddf28a7e996f48949fd8f1ffcd8ef0533e92bf1fa7` | **(Keep this value)** | Used for signing JWTs. |
| **`GOOGLE_CLIENT_ID`** | `
| **`GOOGLE_CLIENT_SECRET`** |
| **`GOOGLE_CALLBACK_URL`** | `http://localhost:3google/callback` | `https://<Your Render URL>/auth/google/callback` | **CRITICAL:** Must match the *Authorized Redirect URI* in your Google Console. |
| **`PAYSTACK_SECRET_KEY`** | 
| **`PAYSTACK_PUBLIC_KEY`** | `

#
## üîí Authentication & Access Control

The service uses two authentication methods:

### 1. JSON Web Token (JWT)
* **Method:** Passed as `Authorization: Bearer <token>`.
* **Source:** Issued after successful Google Sign-in.
* **Access:** Full access to all wallet operations.

### 2. API Keys
* **Method:** Passed as `x-api-key: <key>`.
* **Source:** Generated by the user/owner via `/keys/create`.
* **Access:** Limited by explicitly assigned permissions (`read`, `deposit`, `transfer`).
* **Rules:** Must be active (not expired/revoked) and have the necessary permission for the requested endpoint.

---

## üåê API Endpoints Specification

### 1. Google Authentication (JWT)

| Method | Path | Description |
| :--- | :--- | :--- |
| `GET` | `/auth/google` | Initiates the Google OAuth flow. |
| `GET` | `/auth/google/callback` | Handles the OAuth redirect and **returns the JWT**. |

### 2. API Key Management

| Method | Path | Auth | Description |
| :--- | :--- | :--- | :--- |
| `POST` | `/keys/create` | JWT | Generates a new key with specified permissions (`deposit`, `transfer`, `read`) and expiry (`1H`, `1D`, `1M`, `1Y`). Max 5 active keys. |
| `GET` | `/keys` | JWT | **(Extra Route)** Retrieves a list of all API keys (active, expired, revoked) for the user. |
| `POST` | `/keys/rollover` | JWT | Creates a new key with the same permissions as a specified **expired** key. |

### 3. Wallet Operations

| Method | Path | Auth Required | Permissions | Description |
| :--- | :--- | :--- | :--- | :--- |
| `GET` | `/wallet/balance` | JWT or API Key | `read` | Retrieves the user's current wallet balance. |
| `GET` | `/wallet/transactions` | JWT or API Key | `read` | Retrieves the transaction history. |
| `POST` | `/wallet/deposit` | JWT or API Key | `deposit` | Initiates a Paystack transaction and returns the `authorization_url`. |
| `POST` | `/wallet/transfer` | JWT or API Key | `transfer` | Executes an atomic wallet-to-wallet transfer. Requires sufficient balance. |

### 4. Paystack & Verification

| Method | Path | Auth Required | Action |
| :--- | :--- | :--- | :--- |
| `POST` | `/wallet/paystack/webhook` | **None** (Security via Signature) | **MANDATORY:** Receives transaction updates from Paystack. **VALIDATES SIGNATURE** using `PAYSTACK_SECRET_KEY` and **CREDITS WALLET** upon success. |
| `GET` | `/wallet/deposit/{reference}/status` | JWT or API Key | Optional endpoint to check transaction status. **Does NOT credit the wallet.** |

---

## üõ°Ô∏è Security & Integrity

* **Paystack Signature Validation:** The webhook handler securely validates the incoming request using the `PAYSTACK_SECRET_KEY` to prevent fraudulent wallet crediting.
* **Atomicity:** All wallet transfers are wrapped in database transactions to ensure that money is never partially deducted or credited.
* **Idempotency:** Webhook logic prevents re-processing the same successful transaction reference, ensuring no double-credit.
* **API Key Limits:** Strict enforcement of 5 active keys per user and automatic rejection of expired or permission-deficient keys.